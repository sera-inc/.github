name: é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
on:
  schedule:
    - cron: '0 9 * * FRI'  # æ¯é€±é‡‘æ›œæ—¥9:00 JST
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  issues: read
  pull-requests: read
  contents: write
  pages: write
  id-token: write

jobs:
  generate-weekly-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install @octokit/rest @octokit/auth-github-app
          npm install moment chart.js puppeteer
          
      - name: Collect GitHub Data
        id: collect-data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node << 'EOF'
          const { Octokit } = require("@octokit/rest");
          const moment = require('moment');
          
          const octokit = new Octokit({
            auth: process.env.GITHUB_TOKEN,
          });
          
          const owner = process.env.REPO_OWNER;
          const repo = process.env.REPO_NAME;
          
          async function generateWeeklyReport() {
            const weekStart = moment().subtract(7, 'days').format('YYYY-MM-DD');
            const weekEnd = moment().format('YYYY-MM-DD');
            
            console.log(`ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: ${weekStart} ã€œ ${weekEnd}`);
            
            // Issues ãƒ‡ãƒ¼ã‚¿åé›†
            const { data: issues } = await octokit.rest.issues.listForRepo({
              owner,
              repo,
              state: 'all',
              since: `${weekStart}T00:00:00Z`,
              per_page: 100
            });
            
            // Pull Requests ãƒ‡ãƒ¼ã‚¿åé›†
            const { data: pullRequests } = await octokit.rest.pulls.list({
              owner,
              repo,
              state: 'all',
              per_page: 100
            });
            
            // Project ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆProjects v2 APIä½¿ç”¨ï¼‰
            const query = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      title
                      items(first: 100) {
                        nodes {
                          id
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                text
                                field {
                                  ... on ProjectV2Field {
                                    name
                                  }
                                }
                              }
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const projectData = await octokit.graphql(query, { owner, repo });
            
            // é€²æ—ãƒ‡ãƒ¼ã‚¿åˆ†æ
            const weeklyIssues = issues.filter(issue => {
              const createdDate = moment(issue.created_at);
              return createdDate.isAfter(weekStart) && createdDate.isBefore(weekEnd);
            });
            
            const closedIssues = issues.filter(issue => {
              if (!issue.closed_at) return false;
              const closedDate = moment(issue.closed_at);
              return closedDate.isAfter(weekStart) && closedDate.isBefore(weekEnd);
            });
            
            const weeklyPRs = pullRequests.filter(pr => {
              const createdDate = moment(pr.created_at);
              return createdDate.isAfter(weekStart) && createdDate.isBefore(weekEnd);
            });
            
            const mergedPRs = pullRequests.filter(pr => {
              if (!pr.merged_at) return false;
              const mergedDate = moment(pr.merged_at);
              return mergedDate.isAfter(weekStart) && mergedDate.isBefore(weekEnd);
            });
            
            // æ©Ÿèƒ½åˆ¥é€²æ—åˆ†æ
            const functionProgress = {};
            issues.forEach(issue => {
              const labels = issue.labels.map(label => label.name);
              const component = labels.find(label => 
                ['frontend', 'backend', 'database', 'ui-ux', 'infrastructure'].includes(label)
              ) || 'other';
              
              if (!functionProgress[component]) {
                functionProgress[component] = {
                  total: 0,
                  completed: 0,
                  inProgress: 0,
                  backlog: 0
                };
              }
              
              functionProgress[component].total++;
              
              if (issue.state === 'closed') {
                functionProgress[component].completed++;
              } else if (labels.includes('in-progress')) {
                functionProgress[component].inProgress++;
              } else {
                functionProgress[component].backlog++;
              }
            });
            
            // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const reportData = {
              reportDate: moment().format('YYYY-MM-DD'),
              period: `${weekStart} ã€œ ${weekEnd}`,
              summary: {
                totalIssues: issues.length,
                weeklyNewIssues: weeklyIssues.length,
                weeklyClosedIssues: closedIssues.length,
                totalPRs: pullRequests.length,
                weeklyNewPRs: weeklyPRs.length,
                weeklyMergedPRs: mergedPRs.length,
                completionRate: issues.length > 0 ? Math.round((closedIssues.length / issues.length) * 100) : 0
              },
              functionProgress,
              projectData: projectData.repository.projectsV2.nodes
            };
            
            // JSONå½¢å¼ã§å‡ºåŠ›
            console.log('REPORT_DATA=' + JSON.stringify(reportData));
            
            // HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            const htmlReport = generateHTMLReport(reportData);
            require('fs').writeFileSync('weekly-report.html', htmlReport);
            
            // Markdown ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            const markdownReport = generateMarkdownReport(reportData);
            require('fs').writeFileSync('weekly-report.md', markdownReport);
            
            console.log('âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†');
          }
          
          function generateHTMLReport(data) {
            return `
<!DOCTYPE html>
<html>
<head>
    <title>é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ - ${data.period}</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; background-color: #f6f8fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 2px solid #e1e4e8; padding-bottom: 20px; margin-bottom: 30px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #f6f8fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #0366d6; }
        .card h3 { margin: 0 0 10px 0; color: #24292e; }
        .card .value { font-size: 2em; font-weight: bold; color: #0366d6; }
        .progress-section { margin: 30px 0; }
        .progress-bar { background: #e1e4e8; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #28a745; transition: width 0.3s ease; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e1e4e8; }
        th { background-color: #f6f8fa; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-progress { background: #fff3cd; color: #856404; }
        .status-backlog { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ</h1>
            <h2>${data.period}</h2>
            <p>ç”Ÿæˆæ—¥: ${data.reportDate}</p>
        </div>
        
        <div class="summary-cards">
            <div class="card">
                <h3>ğŸ“‹ ç·Issueæ•°</h3>
                <div class="value">${data.summary.totalIssues}</div>
            </div>
            <div class="card">
                <h3>ğŸ“ ä»Šé€±æ–°è¦Issue</h3>
                <div class="value">${data.summary.weeklyNewIssues}</div>
            </div>
            <div class="card">
                <h3>âœ… ä»Šé€±å®Œäº†Issue</h3>
                <div class="value">${data.summary.weeklyClosedIssues}</div>
            </div>
            <div class="card">
                <h3>ğŸ“ˆ å®Œäº†ç‡</h3>
                <div class="value">${data.summary.completionRate}%</div>
            </div>
            <div class="card">
                <h3>ğŸ”„ ç·PRæ•°</h3>
                <div class="value">${data.summary.totalPRs}</div>
            </div>
            <div class="card">
                <h3>ğŸš€ ä»Šé€±ãƒãƒ¼ã‚¸</h3>
                <div class="value">${data.summary.weeklyMergedPRs}</div>
            </div>
        </div>
        
        <div class="progress-section">
            <h2>ğŸ“Š æ©Ÿèƒ½åˆ¥é€²æ—çŠ¶æ³</h2>
            <table>
                <thead>
                    <tr>
                        <th>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</th>
                        <th>ç·æ•°</th>
                        <th>å®Œäº†</th>
                        <th>é€²è¡Œä¸­</th>
                        <th>æœªç€æ‰‹</th>
                        <th>é€²æ—ç‡</th>
                        <th>é€²æ—ãƒãƒ¼</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(data.functionProgress).map(([component, progress]) => `
                    <tr>
                        <td><strong>${component}</strong></td>
                        <td>${progress.total}</td>
                        <td><span class="status-badge status-completed">${progress.completed}</span></td>
                        <td><span class="status-badge status-progress">${progress.inProgress}</span></td>
                        <td><span class="status-badge status-backlog">${progress.backlog}</span></td>
                        <td>${Math.round((progress.completed / progress.total) * 100)}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(progress.completed / progress.total) * 100}%"></div>
                            </div>
                        </td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p><em>ğŸ“… æ¬¡å›ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆäºˆå®š: ${moment().add(7, 'days').format('YYYY-MM-DD')}</em></p>
            <p>ğŸ”— <a href="https://github.com/${process.env.REPO_OWNER}/${process.env.REPO_NAME}">GitHubãƒªãƒã‚¸ãƒˆãƒª</a></p>
        </div>
    </div>
</body>
</html>
            `;
          }
          
          function generateMarkdownReport(data) {
            return `# ğŸ“Š é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ - ${data.period}

## ğŸ“ˆ ã‚µãƒãƒªãƒ¼
- **ç·Issueæ•°**: ${data.summary.totalIssues}
- **ä»Šé€±æ–°è¦Issue**: ${data.summary.weeklyNewIssues}  
- **ä»Šé€±å®Œäº†Issue**: ${data.summary.weeklyClosedIssues}
- **å®Œäº†ç‡**: ${data.summary.completionRate}%
- **ç·PRæ•°**: ${data.summary.totalPRs}
- **ä»Šé€±ãƒãƒ¼ã‚¸PR**: ${data.summary.weeklyMergedPRs}

## ğŸ”§ æ©Ÿèƒ½åˆ¥é€²æ—

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ç·æ•° | å®Œäº† | é€²è¡Œä¸­ | æœªç€æ‰‹ | é€²æ—ç‡ |
|---|---|---|---|---|---|
${Object.entries(data.functionProgress).map(([component, progress]) => 
`| ${component} | ${progress.total} | ${progress.completed} | ${progress.inProgress} | ${progress.backlog} | ${Math.round((progress.completed / progress.total) * 100)}% |`
).join('\n')}

## ğŸ“… æ¬¡é€±ã®äºˆå®š
- æ¬¡å›ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: ${moment().add(7, 'days').format('YYYY-MM-DD')}
- ç¶™ç¶šç›£è¦–é …ç›®ã®ç¢ºèª
- æ–°è¦èª²é¡Œã¸ã®å¯¾å¿œ

---
*ç”Ÿæˆæ—¥: ${data.reportDate}*
            `;
          }
          
          generateWeeklyReport().catch(console.error);
          EOF
          
      - name: Create GitHub Issue for Weekly Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ğŸ“Š é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ $(date +'%Y-%m-%d')" \
            --body-file weekly-report.md \
            --label "weekly-report,automated" \
            --assignee "${{ github.actor }}"
            
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: reports/weekly
          
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ğŸ“Š é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’ç¢ºèª>"}' \
              $SLACK_WEBHOOK_URL
          fi
