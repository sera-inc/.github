#!/bin/bash

set -e

OWNER="${1:-}"
REPO="${2:-}"
GITHUB_TOKEN="${3:-}"
PROJECT_NAME="${4:-}"

if [ -z "$OWNER" ] || [ -z "$REPO" ] || [ -z "$GITHUB_TOKEN" ]; then
    echo "Usage: $0 <owner> <repo> <github_token> [project_name]"
    echo "Example: $0 sera-inc my-project ghp_xxxxx 'My Project'"
    exit 1
fi

if [ -z "$PROJECT_NAME" ]; then
    PROJECT_NAME="$REPO Project"
fi

echo "ğŸš€ Setting up GitHub Project for $OWNER/$REPO..."
echo "ğŸ“‹ Project Name: $PROJECT_NAME"

API_URL="https://api.github.com"
GRAPHQL_URL="https://api.github.com/graphql"

AUTH_HEADER="Authorization: Bearer $GITHUB_TOKEN"

echo ""
echo "âš ï¸  Note: This script requires GitHub Projects v2 API access."
echo "âš ï¸  GitHub Projects v2 uses GraphQL API which requires organization-level permissions."
echo ""
echo "ğŸ“ Manual Setup Required:"
echo ""
echo "1. Go to: https://github.com/orgs/$OWNER/projects"
echo "2. Click 'New project'"
echo "3. Project name: $PROJECT_NAME"
echo "4. Template: 'Team backlog'"
echo "5. Click 'Create project'"
echo ""
echo "Then configure custom fields:"
echo ""
echo "=== Custom Fields ==="
echo ""
echo "1. Status (Single select) - Edit existing field:"
echo "   - ğŸ“‹ Backlog (Gray)"
echo "   - ğŸ” Ready (Blue)"
echo "   - ğŸš€ In Progress (Yellow)"
echo "   - ğŸ‘€ Review (Orange)"
echo "   - âœ… Done (Green)"
echo "   - âŒ Blocked (Red)"
echo ""
echo "2. Priority (Single select):"
echo "   - ğŸ”´ Critical (Red)"
echo "   - ğŸŸ  High (Orange)"
echo "   - ğŸŸ¡ Medium (Yellow)"
echo "   - ğŸ”µ Low (Blue)"
echo ""
echo "3. Component (Single select):"
echo "   - ğŸ¨ Frontend (Blue)"
echo "   - âš™ï¸ Backend (Purple)"
echo "   - ğŸ—„ï¸ Database (Orange)"
echo "   - ğŸ—ï¸ Infrastructure (Gray)"
echo "   - ğŸ­ UI/UX (Pink)"
echo "   - ğŸ“± API (Green)"
echo ""
echo "4. Sprint (Single select):"
echo "   - Sprint 1 (Blue)"
echo "   - Sprint 2 (Green)"
echo "   - Sprint 3 (Orange)"
echo "   - Sprint 4 (Purple)"
echo ""
echo "5. Story Points (Single select):"
echo "   - 1, 2, 3, 5, 8, 13, 21"
echo ""
echo "6. Must/Want (Single select):"
echo "   - ğŸš¨ Must (Red)"
echo "   - ğŸ’« Want (Blue)"
echo ""
echo "7. Figma Link (URL)"
echo ""
echo "8. Security Status (Single select):"
echo "   - âœ… Checked (Green)"
echo "   - ğŸ” Checking (Yellow)"
echo "   - âŒ Not Checked (Red)"
echo "   - N/A (Gray)"
echo ""
echo "9. Review Status (Single select):"
echo "   - âœ… Approved (Green)"
echo "   - ğŸ” In Review (Orange)"
echo "   - ğŸ“ Changes Requested (Red)"
echo "   - â³ Pending (Yellow)"
echo ""
echo "=== Views ==="
echo ""
echo "1. ğŸ“Š Main Kanban (Board)"
echo "   - Group by: Status"
echo "   - Filter: is:open"
echo "   - Sort: Priority (desc), Story Points (asc)"
echo ""
echo "2. ğŸƒ Sprint Board (Board)"
echo "   - Group by: Status"
echo "   - Filter: is:open, Sprint equals 'Sprint 1'"
echo "   - Sort: Priority (desc)"
echo ""
echo "3. ğŸ‘¥ Team Members (Board)"
echo "   - Group by: Assignees"
echo "   - Filter: is:open"
echo "   - Sort: Priority (desc)"
echo ""
echo "4. ğŸ”¥ Priority View (Table)"
echo "   - Filter: is:open"
echo "   - Sort: Priority (desc), Story Points (desc)"
echo ""
echo "5. ğŸ”§ Component View (Board)"
echo "   - Group by: Component"
echo "   - Filter: is:open"
echo "   - Sort: Priority (desc)"
echo ""
echo "6. ğŸ‘€ Review Pipeline (Board)"
echo "   - Group by: Review Status"
echo "   - Filter: is:open, Status not equal 'Backlog'"
echo "   - Sort: Priority (desc)"
echo ""
echo "7. âœ… Completed Tasks (Table)"
echo "   - Filter: is:closed, closed date within last 30 days"
echo "   - Sort: Closed date (desc)"
echo ""
echo "=== Automation Rules ==="
echo ""
echo "1. Auto-add Issues:"
echo "   - Trigger: Issue created"
echo "   - Action: Add to project"
echo "   - Default: Status=Backlog, Priority=Medium"
echo ""
echo "2. Auto-add Pull Requests:"
echo "   - Trigger: Pull request created"
echo "   - Action: Add to project"
echo "   - Default: Status=Review, Priority=Medium"
echo ""
echo "3. Auto-update on merge:"
echo "   - Trigger: Pull request merged"
echo "   - Action: Set Status to 'Done'"
echo ""
echo "=== Permissions ==="
echo ""
echo "Add team members with appropriate roles:"
echo "  - Project Manager: Admin"
echo "  - Lead Developer: Write"
echo "  - Developers: Write"
echo "  - Designer: Write"
echo "  - QA Engineer: Write"
echo "  - Client: Read"
echo ""
echo "âœ… Setup instructions displayed."
echo ""
echo "ğŸ“š For detailed setup guide, see:"
echo "   https://github.com/$OWNER/.github/blob/main/github-projects-setup.md"
echo ""
echo "ğŸ’¡ Tip: After creating the project, link it to your repository:"
echo "   Repository Settings â†’ Features â†’ Projects â†’ Link a project"
